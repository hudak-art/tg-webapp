<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0" />
<title>–ö–∞–±–∏–Ω–µ—Ç</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    :root {
        --bg-page: #f8fafc;
        --bg-card: #ffffff;
        --fg-main: #0f172a;
        --fg-dim: #64748b;
        --border: #e2e8f0;
        --accent-ok: #16a34a;
        --accent-warn: #eab308;
        --accent-bad: #dc2626;
        --radius-card: 16px;
        --radius-box: 10px;
        --shadow-card: 0 30px 80px rgba(0,0,0,.07);
        --font-main: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",
                     Roboto,"Helvetica Neue",Arial,sans-serif;
    }

    body {
        background: var(--bg-page);
        color: var(--fg-main);
        font-family: var(--font-main);
        margin:0;
        padding:16px;
        line-height:1.45;
    }

    .card{
        background: var(--bg-card);
        border-radius: var(--radius-card);
        padding:16px;
        box-shadow: var(--shadow-card);
        border:1px solid var(--border);
        max-width:480px;
        margin:0 auto 16px;
    }

    h1{
        font-size:18px;
        margin:0 0 4px;
        font-weight:600;
        color:var(--fg-main);
        text-align:center;
        word-break:break-word;
    }

    .sub{
        font-size:13px;
        color:var(--fg-dim);
        text-align:center;
        margin-bottom:12px;
        word-break:break-word;
    }

    .block-title{
        font-size:14px;
        font-weight:600;
        color:var(--fg-main);
        margin:16px 0 8px;
    }

    .box{
        background:#f9fafb;
        border:1px solid var(--border);
        border-radius:var(--radius-box);
        padding:12px;
        font-size:13px;
        color:var(--fg-main);
        margin-bottom:8px;
        line-height:1.4;
        word-break:break-word;
    }

    .rowline{
        margin-bottom:6px;
    }

    .rowline b{
        color:var(--fg-main);
    }

    .bad{
        color:var(--accent-bad);
        font-weight:600;
    }
    .ok{
        color:var(--accent-ok);
        font-weight:600;
    }
    .warn{
        color:var(--accent-warn);
        font-weight:600;
    }

    .hint{
        font-size:12px;
        line-height:1.4;
        color:var(--fg-dim);
        margin-top:8px;
    }

    .pill-row{
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        margin-top:6px;
    }
    .pill{
        background:#eef2ff;
        color:#4338ca;
        border-radius:999px;
        font-size:11px;
        padding:4px 8px;
        line-height:1.2;
        border:1px solid rgba(67,56,202,.15);
        font-weight:500;
    }

    .footer{
        font-size:11px;
        color:var(--fg-dim);
        text-align:center;
        margin-top:16px;
        line-height:1.4;
        word-break:break-word;
    }

    /* —Å–ø–∏—Å–∫–∏ */
    .mini-post{
        background:white;
        border:1px solid var(--border);
        border-radius:var(--radius-box);
        padding:10px 12px;
        font-size:12px;
        margin-bottom:8px;
        line-height:1.4;
    }
    .mini-post .head{
        font-weight:600;
        font-size:12px;
        margin-bottom:4px;
        color:#0f172a;
        word-break:break-word;
    }
    .mini-post .meta{
        font-size:12px;
        color:#475569;
        margin-bottom:4px;
        word-break:break-word;
    }
    .mini-post .res-header{
        font-size:12px;
        font-weight:600;
        color:#0f172a;
        margin-top:6px;
        margin-bottom:2px;
    }
    .mini-post .res-row{
        font-size:12px;
        color:#334155;
        margin-bottom:4px;
        word-break:break-word;
    }

    .table-block{
        font-size:12px;
        background:#fff;
        border:1px solid var(--border);
        border-radius:var(--radius-box);
        padding:10px 12px;
        margin-top:8px;
        line-height:1.4;
        word-break:break-word;
    }
    .table-row{
        margin-bottom:6px;
    }
    .table-row strong{
        color:#0f172a;
    }

</style>
</head>
<body>

<!-- –ö–ê–ë–ò–ù–ï–¢ –ê–ì–ï–ù–¢–ê -->
<div class="card" id="agentCard" style="display:none;">
    <h1>–ö–∞–±–∏–Ω–µ—Ç –∞–≥–µ–Ω—Ç–∞</h1>
    <div class="sub" id="agentUserLine">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="block-title">–¢–≤–æ–π —Å—Ç–∞—Ç—É—Å</div>
    <div class="box">
        <div class="rowline">
            –£—Ä–æ–≤–µ–Ω—å: <b id="agLevel">‚Äî</b>
        </div>
        <div class="rowline">
            –°—Ç—Ä–∞–π–∫–∏: <b id="agStrikes">‚Äî</b>
        </div>
        <div class="rowline">
            –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞: <b id="agBlocked">‚Äî</b>
        </div>
        <div class="hint">
            –£—Ä–æ–≤–µ–Ω—å –¥–∞—ë—Ç –¥–æ—Å—Ç—É–ø –∫ –±–æ–ª–µ–µ –¥–æ—Ä–æ–≥–∏–º —Ç–æ–≤–∞—Ä–∞–º.<br/>
            –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ = –î–ê, –Ω–∞–ø–∏—à–∏ –∞–¥–º–∏–Ω—É.
        </div>
    </div>

    <div class="block-title">–¢–≤–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏</div>
    <div id="agentReservations">
        <div class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="block-title">–ö–∞–∫ –Ω–µ —Å–ª–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–π–∫ üí£</div>
    <div class="box">
        <div class="rowline"><b>1.</b> –ó–∞–±—Ä–∞–ª –ø–ª–æ—â–∞–¥–∫—É ‚Äî —Ä–µ–∞–ª—å–Ω–æ –≤—ã–ª–æ–∂–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.</div>
        <div class="rowline"><b>2.</b> –°—Ä–∞–∑—É –ø—Ä–∏—à–ª–∏ —Å—Å—ã–ª–∫—É –±–æ—Ç—É (http/https).</div>
        <div class="rowline"><b>3.</b> –î–µ–¥–ª–∞–π–Ω –ø–æ –±—Ä–æ–Ω–µ ~12 —á–∞—Å–æ–≤.</div>
        <div class="rowline"><b>4.</b> –ï—Å–ª–∏ —Å–∫–∞–∑–∞–ª–∏ <span class="warn">needs_fix</span> ‚Äî –∏—Å–ø—Ä–∞–≤—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ —Å–Ω–æ–≤–∞ –¥–∞–π —Å—Å—ã–ª–∫—É.</div>
        <div class="rowline"><b>5.</b> –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–±—Ä–∞–ª –∏ –ø—Ä–æ–ø–∞–ª ‚Üí —Å—Ç—Ä–∞–π–∫ <span class="bad">(-)</span>.</div>
        <div class="pill-row">
            <div class="pill">–ë—Ä–æ–Ω—å = –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å</div>
            <div class="pill">–°—Å—ã–ª–∫–∞ = –æ—Ç—á—ë—Ç</div>
            <div class="pill">–ü—Ä–æ—Å—Ä–æ—á–∫–∞ = —Å—Ç—Ä–∞–π–∫</div>
        </div>
        <div class="hint">
            –í –±–æ—Ç–µ –∫–æ–º–∞–Ω–¥–∞ <b>/my</b> –ø–æ–∫–∞–∂–µ—Ç —ç—Ç–∏ –∂–µ –±—Ä–æ–Ω–∏ –∏ —Å—Ä–æ–∫–∏.<br/>
            /whoami ‚Äî —Ç–≤–æ–π —É—Ä–æ–≤–µ–Ω—å, —Å—Ç—Ä–∞–π–∫–∏ –∏ –±–ª–æ–∫.
        </div>
    </div>

    <div class="footer">
        –ï—Å–ª–∏ –ø–æ–∫—É–ø–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è ‚Äî —Å—Ä–∞–∑—É –Ω–∞–ø–∏—à–∏ –∞–¥–º–∏–Ω—É –∏ –≤–ª–∞–¥–µ–ª—å—Ü—É —Ç–æ–≤–∞—Ä–∞.
        –¢–µ–±–µ –≤—ã–ø–ª–∞—Ç—è—Ç –∫–æ–º–∏—Å—Å–∏—é –∏ —Ç–æ–≤–∞—Ä –ø–æ–º–µ—Ç—è—Ç –∫–∞–∫ –ü–†–û–î–ê–ù.
    </div>
</div>


<!-- –ö–ê–ë–ò–ù–ï–¢ –ê–î–ú–ò–ù–ê -->
<div class="card" id="adminCard" style="display:none;">
    <h1>–ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∞</h1>
    <div class="sub" id="adminUserLine">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

    <div class="block-title">–¢–æ–ø –∞–≥–µ–Ω—Ç–æ–≤</div>
    <div id="adminAgents">
        <div class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="block-title">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã</div>
    <div id="adminPosts">
        <div class="box">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="footer">
        –ü–æ–¥—Å–∫–∞–∑–∫–∏:<br/>
        /stats ‚Äî —Å–ø–∏—Å–æ–∫ –∞–≥–µ–Ω—Ç–æ–≤ —Å –±–ª–æ–∫–∞–º–∏/—Å—Ç—Ä–∞–π–∫–∞–º–∏/—É—Ä–æ–≤–Ω—è–º–∏.<br/>
        /postinfo &lt;post_id&gt; ‚Äî –∏—Å—Ç–æ—Ä–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ—Å—Ç–∞.<br/>
        /fix post_id res_id –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –≤—ã—Å—Ç–∞–≤–∏—Ç—å needs_fix.
    </div>
</div>


<script>
(function(){
    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏ –Ω–∞ –¥–æ–º–µ–Ω, –≥–¥–µ –∑–∞–ø—É—â–µ–Ω —Ç–≤–æ–π –±–æ—Ç+API (FastAPI).
    // –ù–∞–ø—Ä–∏–º–µ—Ä: const API_BASE = "https://my-bot.up.railway.app";
    const API_BASE = "https://YOUR-BACKEND-DOMAIN";

    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) {
        try { tg.ready(); } catch(e){}
        try { tg.expand(); } catch(e){}
    }

    // –∫—Ç–æ –∑–∞—à—ë–ª
    let uid = null;
    let uname = "";
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
        uid = tg.initDataUnsafe.user.id || null;
        uname = tg.initDataUnsafe.user.username || "";
    }

    // –∫–∞–∫—É—é —Ä–æ–ª—å —Ö–æ—Ç–∏–º –ø–æ–∫–∞–∑–∞—Ç—å (agent / admin)
    const params = new URLSearchParams(window.location.search);
    const role = params.get("role") || "agent";

    // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/–ø—Ä—è—á–µ–º –±–ª–æ–∫–∏ —Å—Ä–∞–∑—É
    const agentCard = document.getElementById("agentCard");
    const adminCard = document.getElementById("adminCard");

    if (role === "admin") {
        adminCard.style.display = "block";
        agentCard.style.display = "none";
    } else {
        agentCard.style.display = "block";
        adminCard.style.display = "none";
    }

    // –ø–æ–¥–ø–∏—Å–∏ –∫—Ç–æ –∑–∞—à—ë–ª
    const agentUserLine = document.getElementById("agentUserLine");
    const adminUserLine = document.getElementById("adminUserLine");
    const userLineText = "ID: " + (uid ?? "‚Äî") + (uname ? (" @" + uname) : "");
    if (agentUserLine) agentUserLine.innerText = userLineText;
    if (adminUserLine) adminUserLine.innerText = userLineText;

    // –µ—Å–ª–∏ uid –Ω–µ—Ç, –¥–∞–ª—å—à–µ —Å–º—ã—Å–ª–∞ –Ω–µ—Ç
    if (!uid) {
        if (role === "agent") {
            fillAgentError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–≤–æ–π ID –∏–∑ Telegram WebApp.");
        } else {
            fillAdminError("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–≤–æ–π ID –∏–∑ Telegram WebApp.");
        }
        return;
    }

    // –≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–æ–ª–∏
    if (role === "admin") {
        fetchAdmin(uid);
    } else {
        fetchAgent(uid);
    }

    // ---------------------------
    // –†–ï–ù–î–ï–† –ê–ì–ï–ù–¢–ê
    // ---------------------------
    function fillAgentError(msg){
        const box = document.createElement("div");
        box.className = "box";
        box.textContent = msg;
        const wrap = document.getElementById("agentReservations");
        wrap.innerHTML = "";
        wrap.appendChild(box);
        document.getElementById("agLevel").innerText = "‚Äî";
        document.getElementById("agStrikes").innerText = "‚Äî";
        document.getElementById("agBlocked").innerText = "‚Äî";
    }

    function renderAgent(data){
        // —Å—Ç–∞—Ç—É—Å
        document.getElementById("agLevel").innerText = data.level ?? "0";
        document.getElementById("agStrikes").innerText = data.strike_count ?? "0";
        document.getElementById("agBlocked").innerText = data.blocked ? "–î–ê" : "–Ω–µ—Ç";

        // –±—Ä–æ–Ω–∏
        const wrap = document.getElementById("agentReservations");
        wrap.innerHTML = "";

        if (!data.active_reservations || data.active_reservations.length === 0){
            const box = document.createElement("div");
            box.className = "box";
            box.innerHTML = "–£ —Ç–µ–±—è –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π —Å–µ–π—á–∞—Å.<br/>–ö–æ–º–∞–Ω–¥–∞ /my –≤ –±–æ—Ç–µ –ø–æ–∫–∞–∂–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ.";
            wrap.appendChild(box);
            return;
        }

        data.active_reservations.forEach(item => {
            const div = document.createElement("div");
            div.className = "mini-post";

            const head = document.createElement("div");
            head.className = "head";
            head.textContent = `post_id=${item.post_id} | ${item.resource_name} | ${item.status}`;
            div.appendChild(head);

            const meta = document.createElement("div");
            meta.className = "meta";
            let arr = [];
            if (item.expires_at) arr.push("–¥–µ–¥–ª–∞–π–Ω: " + item.expires_at);
            if (item.submitted_link) arr.push("—Å—Å—ã–ª–∫–∞: " + item.submitted_link);
            if (item.fix_reason) arr.push("–ø—Ä–∞–≤–∫–∞: " + item.fix_reason);
            meta.innerHTML = arr.join("<br/>") || "‚Äî";
            div.appendChild(meta);

            const info = document.createElement("div");
            info.className = "meta";
            let infoLines = [];
            if (item.post_price) infoLines.push("–¶–µ–Ω–∞: " + item.post_price);
            if (item.post_agent_fee) infoLines.push("–ê–≥–µ–Ω—Ç—É: " + item.post_agent_fee);
            if (item.post_conditions) infoLines.push("–£—Å–ª–æ–≤–∏—è: " + item.post_conditions);
            if (item.post_deleted) infoLines.push("–°—Ç–∞—Ç—É—Å –ø–æ—Å—Ç–∞: –°–ù–Ø–¢–û");
            if (item.post_sold) infoLines.push("–°—Ç–∞—Ç—É—Å –ø–æ—Å—Ç–∞: –ü–†–û–î–ê–ù–û");
            info.innerHTML = infoLines.join("<br/>") || "";
            div.appendChild(info);

            wrap.appendChild(div);
        });
    }

    function fetchAgent(uid){
        fetch(`${API_BASE}/api/agent_dashboard?user_id=${encodeURIComponent(uid)}`)
            .then(r => r.json())
            .then(data => {
                if (!data || !data.ok){
                    fillAgentError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–∞.");
                    return;
                }
                renderAgent(data);
            })
            .catch(e => {
                fillAgentError("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å.");
            });
    }

    // ---------------------------
    // –†–ï–ù–î–ï–† –ê–î–ú–ò–ù–ê
    // ---------------------------
    function fillAdminError(msg){
        const agentsWrap = document.getElementById("adminAgents");
        const postsWrap = document.getElementById("adminPosts");
        agentsWrap.innerHTML = "";
        postsWrap.innerHTML = "";

        const box1 = document.createElement("div");
        box1.className = "box";
        box1.textContent = msg;
        agentsWrap.appendChild(box1);

        const box2 = document.createElement("div");
        box2.className = "box";
        box2.textContent = msg;
        postsWrap.appendChild(box2);
    }

    function renderAdmin(data){
        // top agents
        const agentsWrap = document.getElementById("adminAgents");
        agentsWrap.innerHTML = "";
        if (!data.top_agents || data.top_agents.length === 0){
            const box = document.createElement("div");
            box.className = "box";
            box.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ –∞–≥–µ–Ω—Ç–∞–º.";
            agentsWrap.appendChild(box);
        } else {
            const table = document.createElement("div");
            table.className = "table-block";

            data.top_agents.forEach(a => {
                const row = document.createElement("div");
                row.className = "table-row";
                row.innerHTML = `
                    <strong>${a.user_id}</strong>
                    | lvl ${a.level}
                    | strikes ${a.strike_count}
                    | blocked ${a.blocked ? "–î–ê" : "–Ω–µ—Ç"}
                `;
                table.appendChild(row);
            });

            agentsWrap.appendChild(table);
        }

        // recent posts
        const postsWrap = document.getElementById("adminPosts");
        postsWrap.innerHTML = "";

        if (!data.recent_posts || data.recent_posts.length === 0){
            const box = document.createElement("div");
            box.className = "box";
            box.textContent = "–ü–æ—Å—Ç–æ–≤ –Ω–µ—Ç.";
            postsWrap.appendChild(box);
        } else {
            data.recent_posts.forEach(p => {
                const div = document.createElement("div");
                div.className = "mini-post";

                const head = document.createElement("div");
                head.className = "head";
                head.textContent = `post_id=${p.post_id} | lvl>=${p.min_level_required}`;
                div.appendChild(head);

                const meta = document.createElement("div");
                meta.className = "meta";
                const statusLines = [];
                if (p.is_deleted) statusLines.push("–°–ù–Ø–¢–û");
                if (p.is_sold) statusLines.push("–ü–†–û–î–ê–ù–û");
                meta.innerHTML = `
                    –¶–µ–Ω–∞: ${p.price || "‚Äî"}<br/>
                    –ê–≥–µ–Ω—Ç—É: ${p.agent_fee || "‚Äî"}<br/>
                    –£—Å–ª–æ–≤–∏—è: ${p.conditions || "‚Äî"}<br/>
                    –°—Ç–∞—Ç—É—Å: ${statusLines.join(", ") || "–∞–∫—Ç–∏–≤–µ–Ω"}
                `;
                div.appendChild(meta);

                if (p.resources && p.resources.length){
                    const resHeader = document.createElement("div");
                    resHeader.className = "res-header";
                    resHeader.textContent = "–ü–ª–æ—â–∞–¥–∫–∏:";
                    div.appendChild(resHeader);

                    p.resources.forEach(r => {
                        const rr = document.createElement("div");
                        rr.className = "res-row";
                        rr.innerHTML = `
                            ${r.resource_name} ‚Üí ${r.status}
                            ${r.agent_user_id ? (" | –∞–≥–µ–Ω—Ç " + r.agent_user_id) : ""}
                            ${r.expires_at ? (" | –¥–µ–¥–ª–∞–π–Ω " + r.expires_at) : ""}<br/>
                            ${r.submitted_link ? ("—Å—Å—ã–ª–∫–∞: " + r.submitted_link + "<br/>") : ""}
                            ${r.fix_reason ? ("fix: " + r.fix_reason) : ""}
                        `;
                        div.appendChild(rr);
                    });
                }

                postsWrap.appendChild(div);
            });
        }
    }

    function fetchAdmin(uid){
        fetch(`${API_BASE}/api/admin_dashboard?user_id=${encodeURIComponent(uid)}`)
            .then(r => r.json())
            .then(data => {
                if (!data || !data.ok || !data.is_admin){
                    fillAdminError("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–∞–ª –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∞.");
                    return;
                }
                renderAdmin(data);
            })
            .catch(e => {
                fillAdminError("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å.");
            });
    }

})();
</script>

</body>
</html>
