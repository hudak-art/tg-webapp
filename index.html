<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width,initial-scale=1.0,maximum-scale=1.0" />
<title>Новое объявление</title>

<!-- ОБЯЗАТЕЛЬНО: без этого Telegram.WebApp не появится -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    body {
        background: #0f172a;
        color: #f8fafc;
        font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",
                     Roboto,"Helvetica Neue",Arial,sans-serif;
        margin:0;
        padding:16px;
    }

    .card {
        background:#1e293b;
        border-radius:16px;
        padding:16px;
        box-shadow:0 20px 60px rgba(0,0,0,.6);
        border:1px solid #334155;
        max-width:480px;
        margin:0 auto;
    }

    h1 {
        font-size:18px;
        margin:0 0 12px;
        font-weight:600;
        color:#fff;
        text-align:center;
    }

    label {
        font-size:13px;
        font-weight:500;
        color:#cbd5e1;
        display:block;
        margin-bottom:4px;
    }

    input,textarea {
        width:100%;
        border-radius:10px;
        border:1px solid #475569;
        background:#0f172a;
        padding:10px 12px;
        font-size:14px;
        color:#f8fafc;
        outline:none;
        box-sizing:border-box;
    }
    input:focus,textarea:focus {
        border-color:#38bdf8;
        box-shadow:0 0 0 2px rgba(56,189,248,.2);
    }

    .group { margin-bottom:12px; }

    .row-2col {
        display:flex;
        gap:12px;
    }
    .row-2col .group {
        flex:1;
        margin-bottom:0;
    }

    .preview-wrap {
        display:flex;
        flex-wrap:wrap;
        gap:8px;
        margin-top:8px;
    }
    .preview-wrap img {
        width:64px;
        height:64px;
        object-fit:cover;
        border-radius:8px;
        border:1px solid #475569;
        box-shadow:0 10px 20px rgba(0,0,0,.5);
    }

    button.send-btn {
        width:100%;
        background:linear-gradient(90deg,#0ea5e9,#6366f1);
        border:0;
        border-radius:12px;
        padding:12px;
        color:#fff;
        font-size:15px;
        font-weight:600;
        cursor:pointer;
        box-shadow:0 16px 40px rgba(14,165,233,.4);
    }
    button.send-btn:active {
        transform:scale(.98);
    }

    small.hint {
        display:block;
        font-size:12px;
        line-height:1.4;
        color:#94a3b8;
        margin-top:8px;
        text-align:center;
    }

    .footer {
        font-size:11px;
        color:#475569;
        text-align:center;
        margin-top:16px;
        line-height:1.4;
    }
</style>
</head>
<body>
<div class="card">
    <h1>Новое объявление</h1>

    <div class="group">
        <label for="title">Заголовок / что продаём</label>
        <input id="title" placeholder="Пример: iPhone 13, идеальное состояние" />
    </div>

    <div class="row-2col">
        <div class="group">
            <label for="price">Цена</label>
            <input id="price" placeholder="Например: 12 500 грн" />
        </div>
        <div class="group">
            <label for="fee">Агенту</label>
            <input id="fee" placeholder="Например: 500 грн" />
        </div>
    </div>

    <div class="group">
        <label for="cond">Условия</label>
        <input id="cond" placeholder="Самовывоз / могу отправить НП / Измаил" />
    </div>

    <div class="group">
        <label for="desc">Описание</label>
        <textarea id="desc" rows="4"
            placeholder="Состояние, комплектация, почему продаёшь..."></textarea>
    </div>

    <div class="group">
        <label for="photos">Фото (галерея, не обязательно)</label>
        <input id="photos" type="file" accept="image/*" multiple />
        <div id="preview" class="preview-wrap"></div>
        <small class="hint">
            Эти фото реально пойдут в объявление.<br/>
            После отправки формы бот попросит кинуть их ему в чат (как альбом),<br/>
            и сразу опубликует пост уже с фото.
        </small>
    </div>

    <button class="send-btn" id="sendBtn">Отправить в бота</button>

    <small class="hint">
        После этого бот пришлёт черновик объявления в личку и попросит фото.
        Если фото нет — просто напиши ему "БЕЗ ФОТО".
    </small>

    <div class="footer">
        Это окно Telegram WebApp.<br/>
        Можно закрыть после отправки.
    </div>
</div>

<script>
// обёртка чтобы ничего не утекало в глобальный scope
(function () {

    // берём объект Telegram.WebApp, если он есть
    function getTg() {
        if (window.Telegram && window.Telegram.WebApp) {
            return window.Telegram.WebApp;
        }
        return null;
    }

    // инициализация как советует Telegram
    const tg = getTg();
    if (tg) {
        try { tg.ready(); } catch(e){}
        try { tg.expand(); } catch(e){}
        // эта штука просит подтверждение при закрытии
        // если пользователь что-то заполнил
        try { tg.enableClosingConfirmation(); } catch(e){}
    }

    // элементы формы
    const titleInput  = document.getElementById("title");
    const priceInput  = document.getElementById("price");
    const feeInput    = document.getElementById("fee");
    const condInput   = document.getElementById("cond");
    const descInput   = document.getElementById("desc");
    const photosInput = document.getElementById("photos");

    const previewBox  = document.getElementById("preview");
    const sendBtn     = document.getElementById("sendBtn");

    // превью фоток (только локально для визуала)
    photosInput.addEventListener("change", () => {
        previewBox.innerHTML = "";
        const files = photosInput.files;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = document.createElement("img");
                img.src = e.target.result;
                previewBox.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    });

    // отправка данных в бота
    sendBtn.addEventListener("click", () => {
        const tgNow = getTg();

        const payload = {
            title: titleInput.value.trim(),
            price: priceInput.value.trim(),
            fee:   feeInput.value.trim(),
            cond:  condInput.value.trim(),
            desc:  descInput.value.trim(),
            // сюда не пихаем сами картинки, просто считаем
            photosCount: photosInput.files.length
        };

        if (!tgNow) {
            alert(
                "Telegram.WebApp не инициализирован.\n" +
                "Открой эту форму через /new у бота, " +
                "а не через обычный браузер."
            );
            return;
        }

        // визуально показываем, что пошла отправка
        sendBtn.disabled = true;
        sendBtn.textContent = "Отправляю...";

        try {
            // шлём данные в бота
            tgNow.sendData(JSON.stringify(payload));
        } catch (err) {
            alert("Ошибка отправки в бота: " + err.message);
            sendBtn.disabled = false;
            sendBtn.textContent = "Отправить в бота";
            return;
        }

        // даём Телеграму время отправить sendData,
        // потом закрываем приложение
        setTimeout(() => {
            try { tgNow.close(); } catch(e){}
        }, 300);
    });

})();
</script>
</body>
</html>
