<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<title>Новое объявление</title>

<!-- ВАЖНО: это даёт window.Telegram.WebApp -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
    body {
        background: #0f172a;
        color: #f8fafc;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
                     Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 16px;
    }

    .card {
        background: #1e293b;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,.6);
        border: 1px solid #334155;
        max-width: 480px;
        margin: 0 auto;
    }

    h1 {
        font-size: 18px;
        margin: 0 0 12px;
        font-weight: 600;
        color: #fff;
        text-align: center;
    }

    label {
        font-size: 13px;
        font-weight: 500;
        color: #cbd5e1;
        display: block;
        margin-bottom: 4px;
    }

    input,
    textarea {
        width: 100%;
        border-radius: 10px;
        border: 1px solid #475569;
        background: #0f172a;
        padding: 10px 12px;
        font-size: 14px;
        color: #f8fafc;
        outline: none;
        box-sizing: border-box;
    }

    input:focus,
    textarea:focus {
        border-color: #38bdf8;
        box-shadow: 0 0 0 2px rgba(56,189,248,.2);
    }

    .group {
        margin-bottom: 12px;
    }

    .row-2col {
        display: flex;
        gap: 12px;
    }
    .row-2col .group {
        flex: 1;
        margin-bottom: 0;
    }

    button.send-btn {
        width: 100%;
        background: linear-gradient(90deg,#0ea5e9,#6366f1);
        border: 0;
        border-radius: 12px;
        padding: 12px;
        color: #fff;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 16px 40px rgba(14,165,233,.4);
    }
    button.send-btn:active {
        transform: scale(.98);
    }

    small.hint {
        display: block;
        font-size: 12px;
        line-height: 1.4;
        color: #94a3b8;
        margin-top: 8px;
        text-align: center;
    }

    .footer {
        font-size: 11px;
        color: #475569;
        text-align: center;
        margin-top: 16px;
        line-height: 1.4;
    }
</style>
</head>
<body>
<div class="card">
    <h1>Новое объявление</h1>

    <div class="group">
        <label for="title">Заголовок / что продаём</label>
        <input id="title" placeholder="Пример: iPhone 13, идеал" />
    </div>

    <div class="row-2col">
        <div class="group">
            <label for="price">Цена</label>
            <input id="price" placeholder="12 500 грн" />
        </div>
        <div class="group">
            <label for="fee">Агенту</label>
            <input id="fee" placeholder="500 грн" />
        </div>
    </div>

    <div class="group">
        <label for="cond">Условия</label>
        <input id="cond" placeholder="Измаил, самовывоз / могу отправить НП" />
    </div>

    <div class="group">
        <label for="desc">Описание</label>
        <textarea id="desc" rows="4" placeholder="Состояние, комплектация, почему продаю..."></textarea>
    </div>

    <button class="send-btn" id="sendBtn">Отправить в бота</button>

    <small class="hint">
        После отправки бот:
        1) создаст пост в группе,<br/>
        2) пришлёт тебе в личку карточку товара и список площадок,<br/>
        3) попросит тебя дальше.
    </small>

    <div class="footer">
        Это окно Telegram WebApp.<br/>
        После отправки можно закрыть.
    </div>
</div>

<script>
    // Берём объект WebApp из Telegram
    const tg = window.Telegram && window.Telegram.WebApp
        ? window.Telegram.WebApp
        : null;

    // Если мы реально открыты внутри Telegram (/new), tg будет не null
    if (tg) {
        tg.expand(); // растянуть на всю высоту
        tg.enableClosingConfirmation(); // спросит при закрытии с незасланными данными
    }

    const sendBtn = document.getElementById("sendBtn");

    sendBtn.addEventListener("click", () => {
        // Собираем данные формы
        const title = document.getElementById("title").value.trim();
        const price = document.getElementById("price").value.trim();
        const fee   = document.getElementById("fee").value.trim();
        const cond  = document.getElementById("cond").value.trim();
        const desc  = document.getElementById("desc").value.trim();

        const payload = {
            title: title,
            price: price,
            fee:   fee,
            cond:  cond,
            desc:  desc
            // photos: []  // если потом добавим поддержку file_id фоток
        };

        if (!tg) {
            alert("Telegram.WebApp не инициализирован. Открой через бота /new в Telegram, а не через браузер.");
            return;
        }

        // Блокируем кнопку, чтобы не спамили
        sendBtn.disabled = true;
        sendBtn.textContent = "Отправляю...";

        try {
            // Отправляем JSON прямо в бот (хендлер F.web_app_data)
            tg.sendData(JSON.stringify(payload));

            // Закрываем форму обратно
            tg.close();
        } catch (e) {
            alert("Ошибка отправки в бота: " + e.message);
            sendBtn.disabled = false;
            sendBtn.textContent = "Отправить в бота";
        }
    });
</script>
</body>
</html>
